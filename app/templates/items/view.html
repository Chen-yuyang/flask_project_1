{% extends "base.html" %}

{% block title %}{{ item.name }} - 物品管理系统{% endblock %}

{% block content %}
<!-- 顶部面包屑与操作栏 -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('spaces.index') }}">首页</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('spaces.view', id=item.space.id) }}">{{ item.space.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ item.name }}</li>
        </ol>
    </nav>
    <div class="d-flex gap-2">
        {% if current_user.is_admin() %}
        <a href="{{ url_for('items.edit', id=item.id) }}" class="btn btn-primary">
            <i class="bi bi-pencil"></i> 编辑
        </a>
        {% endif %}
        <a href="{{ url_for('items.all_items') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回列表
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- 左侧：核心信息区 -->
    <div class="col-lg-8">
        <!-- 1. 物品基本概况卡片 -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h1 class="h2 fw-bold text-dark mb-0">{{ item.name }}</h1>
                    <!-- 状态徽章 -->
                    <span class="badge rounded-pill px-3 py-2 fs-6 bg-{{
                        'success' if item.status == 'available' else
                        'warning' if item.status == 'reserved' else 'danger'
                    }}">
                        {{ item.status|replace('available', '可用')|replace('reserved', '已预约')|replace('borrowed', '已借出') }}
                    </span>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="text-muted small fw-bold text-uppercase">编号</label>
                        <p class="fs-5 font-monospace mb-0">{{ item.serial_number }}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small fw-bold text-uppercase">存放位置</label>
                        <p class="fs-5 mb-0">
                            <a href="{{ url_for('spaces.view', id=item.space.id) }}" class="text-decoration-none">
                                <i class="bi bi-geo-alt-fill text-danger me-1"></i>{{ item.space.get_path() }}
                            </a>
                        </p>
                    </div>
                    <div class="col-12">
                        <label class="text-muted small fw-bold text-uppercase">功能描述</label>
                        <p class="text-secondary mb-0">{{ item.function or '暂无描述' }}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small fw-bold text-uppercase">创建时间</label>
                        <p class="small text-muted mb-0">{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small fw-bold text-uppercase">最后更新</label>
                        <p class="small text-muted mb-0">{{ item.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                </div>

                <!-- 常用操作按钮组 -->
                <div class="d-flex gap-3 mt-4 pt-3 border-top">
                    {% if item.status == 'available' %}
                    <a href="{{ url_for('records.create', item_id=item.id) }}" class="btn btn-success flex-grow-1">
                        <i class="bi bi-play-fill me-1"></i> 立即使用
                    </a>
                    {% else %}
                    <button class="btn btn-light text-muted flex-grow-1" disabled>
                        <i class="bi bi-slash-circle me-1"></i> 暂不可用
                    </button>
                    {% endif %}
                    <a href="{{ url_for('reservations.create', item_id=item.id) }}" class="btn btn-warning text-dark flex-grow-1">
                        <i class="bi bi-calendar-plus me-1"></i> 预约物品
                    </a>
                </div>
            </div>
        </div>

        <!-- 2. 动态状态卡片 (借用中/预约中) -->
        {% if current_record or active_reservations %}
        <div class="card shadow-sm border-0 rounded-4 mb-4 border-start border-4 border-warning">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-3">当前状态详情</h5>

                <!-- 正在使用 -->
                {% if current_record %}
                <div class="alert alert-light border d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <span class="badge bg-danger me-2">使用中</span>
                        <strong>{{ current_record.user.username }}</strong>
                        <span class="text-muted small mx-2">|</span>
                        <small class="text-muted">开始于: {{ current_record.start_time.strftime('%m-%d %H:%M') }}</small>
                        {% if current_record.usage_location %}
                        <div class="small text-muted mt-1"><i class="bi bi-pin-map me-1"></i>{{ current_record.usage_location }}</div>
                        {% endif %}
                    </div>

                    <!-- 归还按钮 -->
                    {% if current_user.is_admin() or current_record.user_id == current_user.id %}
                    <form action="{{ url_for('records.return_item', record_id=current_record.id) }}" method="get">
                        <button type="submit" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-box-arrow-in-right me-1"></i>归还
                        </button>
                    </form>
                    {% endif %}
                </div>
                {% endif %}

                <!-- 有效预约 -->
                {% if active_reservations %}
                <h6 class="text-muted small fw-bold text-uppercase mt-3 mb-2">即将进行的预约</h6>
                <ul class="list-group list-group-flush">
                    {% for res in active_reservations %}
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-calendar-event text-warning me-2"></i>
                            <strong>{{ res.user.username }}</strong>
                            <small class="text-muted ms-2">
                                {{ res.reservation_start.strftime('%m-%d %H:%M') }} - {{ res.reservation_end.strftime('%m-%d %H:%M') }}
                            </small>
                        </div>
                        <span class="badge bg-light text-dark border">已排期</span>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- 3. 历史记录 (宽栏展示) -->
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">最近记录</h5>
                <a href="{{ url_for('records.item_records', item_id=item.id) }}" class="text-decoration-none small">查看全部 &rarr;</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">用户</th>
                            <th>时间</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_records %}
                            {% for record in recent_records %}
                            <tr>
                                <td class="ps-4">{{ record.user.username }}</td>
                                <td class="small text-muted">
                                    {{ record.start_time.strftime('%Y-%m-%d') }}
                                    <span class="mx-1 text-secondary">至</span>
                                    {% if record.return_time %}
                                        {{ record.return_time.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        <span class="text-danger">使用中</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.status == 'using' %}
                                        <span class="badge bg-danger bg-opacity-10 text-danger">未归还</span>
                                    {% else %}
                                        <span class="badge bg-success bg-opacity-10 text-success">已完成</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="3" class="text-center py-4 text-muted">暂无历史记录</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 右侧：二维码与附件 -->
    <div class="col-lg-4">
        <!-- 二维码卡片 -->
        <div class="card shadow-sm border-0 rounded-4 text-center p-4">
            <h5 class="fw-bold mb-3">物品二维码</h5>
            {% if item.barcode_path %}
                {% set fixed_path = item.barcode_path.replace('static', '').replace('\\', '/').lstrip('/') %}
                <div class="bg-light rounded p-3 d-inline-block mb-3">
                    <img src="{{ url_for('static', filename=fixed_path) }}"
                         alt="二维码"
                         class="img-fluid"
                         style="width: 180px; height: 180px;">
                </div>
                <!-- 下载按钮，强制重命名为 物品名称_编号.png -->
                <div class="d-grid">
                    <button type="button"
                            onclick="forceDownload('{{ url_for('static', filename=fixed_path) }}', '{{ item.name }}_{{ item.serial_number }}.png')"
                            class="btn btn-outline-primary">
                        <i class="bi bi-download me-1"></i> 下载二维码
                    </button>
                </div>
            {% else %}
                <div class="py-4 text-muted">
                    <i class="bi bi-qr-code-scan display-4 d-block mb-2 text-secondary opacity-50"></i>
                    暂无二维码
                </div>
                {% if current_user.is_admin() %}
                <div class="d-grid">
                    <a href="{{ url_for('items.edit', id=item.id) }}" class="btn btn-primary">
                        <i class="bi bi-arrow-repeat me-1"></i> 前往生成
                    </a>
                </div>
                <small class="text-muted mt-2 d-block">保存编辑即可自动生成</small>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 强制下载并重命名函数
    function forceDownload(url, filename) {
        fetch(url)
            .then(response => response.blob())
            .then(blob => {
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            })
            .catch(error => {
                console.error('下载失败:', error);
                alert('下载失败，请尝试右键另存为。');
            });
    }
</script>
{% endblock %}