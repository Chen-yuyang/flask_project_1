{% extends "base.html" %}

{% block title %}搜索结果 - 物品管理系统{% endblock %}

{% block content %}
<!-- 搜索条件与结果统计 -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>搜索结果："{{ query }}"</h1>
    <span class="badge bg-primary fs-6">{{ total_results }} 个匹配项</span>
</div>

<!-- 新增：搜索范围说明（用info类型alert，醒目且不刺眼） -->
<div class="alert alert-info mb-4" role="alert">
    <h6 class="alert-heading">搜索范围说明</h6>
    <ul class="mb-0 mt-2">
        <li><strong>物品搜索</strong>：匹配物品名称、功能描述、物品编号（支持模糊匹配）</li>
        <li><strong>使用记录搜索</strong>：匹配使用地点、空间路径（支持模糊匹配）</li>
        <li><strong>空间搜索</strong>：匹配空间名称（支持模糊匹配）</li>
    </ul>
</div>

<!-- 标签页切换 -->
<ul class="nav nav-tabs mb-4" id="searchTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">
            物品 ({{ results['items']|length }})  <!-- 修复：.items → ['items'] -->
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records" type="button" role="tab">
            使用记录 ({{ results['records']|length }})  <!-- 修复：.records → ['records'] -->
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="spaces-tab" data-bs-toggle="tab" data-bs-target="#spaces" type="button" role="tab">
            空间 ({{ results['spaces']|length }})  <!-- 修复：.spaces → ['spaces'] -->
        </button>
    </li>
</ul>

<!-- 搜索结果内容 -->
<div class="tab-content" id="searchTabsContent">
    <!-- 物品结果 -->
    <div class="tab-pane fade show active" id="items" role="tabpanel">
        {% if results['items'] %}  <!-- 修复：.items → ['items'] -->
        <div class="table-responsive">
            <table class="table table-striped table-hover shadow">
                <thead class="table-primary">
                    <tr>
                        <th>名称</th>
                        <th>空间路径</th>
                        <th>编号</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in results['items'] %}  <!-- 修复：.items → ['items'] -->
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>
                            <a href="{{ url_for('spaces.view', id=item.space.id) }}">{{ item.space.get_path() }}</a>
                        </td>
                        <td>{{ item.serial_number }}</td>
                        <td>
                            <span class="badge bg-{{
                                'success' if item.status == 'available' else
                                'warning' if item.status == 'reserved' else 'danger'
                            }}">
                                {{ item.status|replace('available', '可用')|replace('reserved', '已预约')|replace('borrowed', '已借出') }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('items.view', id=item.id) }}" class="btn btn-sm btn-info">查看</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center">没有找到匹配的物品</div>
        {% endif %}
    </div>

    <!-- 记录结果 -->
    <div class="tab-pane fade" id="records" role="tabpanel">
        {% if results['records'] %}  <!-- 修复：.records → ['records'] -->
        <div class="table-responsive">
            <table class="table table-striped table-hover shadow">
                <thead class="table-primary">
                    <tr>
                        <th>物品</th>
                        <th>使用人</th>
                        <th>空间路径</th>
                        <th>使用地点</th>
                        <th>时间范围</th>
                        <th>状态</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in results['records'] %}  <!-- 修复：.records → ['records'] -->
                    <tr>
                        <td>
                            <a href="{{ url_for('items.view', id=record.item.id) }}">{{ record.item.name }}</a>
                        </td>
                        <td>{{ record.user.username }}</td>
                        <td>{{ record.space_path }}</td>
                        <td>{{ record.usage_location }}</td>
                        <td>
                            {{ record.start_time.strftime('%Y-%m-%d') }}
                            {% if record.return_time %}
                            - {{ record.return_time.strftime('%Y-%m-%d') }}
                            {% else %}
                            - 至今
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ 'success' if record.status == 'returned' else 'danger' }}">
                                {{ '已归还' if record.status == 'returned' else '使用中' }}
                            </span>
                            {% if record.is_overdue() %}
                            <span class="badge bg-dark">已逾期</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info text-center">没有找到匹配的使用记录</div>
        {% endif %}
    </div>

    <!-- 空间结果 -->
    <div class="tab-pane fade" id="spaces" role="tabpanel">
        {% if results['spaces'] %}  <!-- 修复：.spaces → ['spaces'] -->
        <div class="row gap-3">
            {% for space in results['spaces'] %}  <!-- 修复：.spaces → ['spaces'] -->
            <div class="col-md-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="card-title mb-0">{{ space.name }}</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text"><strong>路径：</strong>{{ space.get_path() }}</p>
                        <p class="card-text"><strong>子空间：</strong>{{ space.children.count() }} 个</p>
                        <p class="card-text"><strong>物品：</strong>{{ space.items.count() }} 个</p>
                        <a href="{{ url_for('spaces.view', id=space.id) }}" class="btn btn-primary w-100">查看详情</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info text-center">没有找到匹配的空间</div>
        {% endif %}
    </div>
</div>
{% endblock %}